<!DOCTYPE html>
<html>

<head>
  <!-- Shaka Player compiled library: -->
  <script src="shaka-player.compiled.js"></script>

  <!-- Required to stream HLS chunks from shaka -->
  <script src="mux.js"></script>

</head>

<body>

  <input value="http://localhost:8585/public/test.mkv" id="url" />
  <button id="load">Load file</button>


  <select id="video"></select>
  <select id="audio"></select>
  <select id="subtitle"></select>


  <select id="quality"></select>

  <select id="protocol" disabled>
    <option value="HLS" selected>HLS</option>
    <option value="DASH">DASH</option>
    <option value="LP">Long-Polling</option>
    <option value="DOWNLOAD">Download</option>
  </select>

  <button id="play">Play!</button>

  <br />
  <video id="player_video" width="640" controls autoplay></video>
</body>

</html>


<script>
  document.querySelector('#load').addEventListener('click', () => {
    const url = document.querySelector('#url').value;
    fetch('http://localhost:8585/media/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    }).then(d => d.json()).then(data => {
      console.log(data.profiles)
      const innerSelect = [...data.profiles].reverse().map((e, index) => (`<option value="${e.id}" ${!index ? 'selected' : ''}>${e.name}</option>`));
      document.querySelector('#quality').innerHTML = innerSelect.join('');

      const innerSelectAudio = data.tracks.audio.map((e, index) => (`<option value="${e.id}" ${!index ? 'selected' : ''}>${e.language} - ${e.codec_name}</option>`));
      document.querySelector('#audio').innerHTML = innerSelectAudio.join('');

      const innerSelectVideo = data.tracks.video.map((e, index) => (`<option value="${e.id}" ${!index ? 'selected' : ''}>${e.language} - ${e.codec_name}</option>`));
      document.querySelector('#video').innerHTML = innerSelectVideo.join('');

      const innerSelectSubtitle = data.tracks.subtitle.map((e, index) => (`<option value="${e.id}" ${!index ? 'selected' : ''}>${e.language} - ${e.codec_name}</option>`));
      document.querySelector('#subtitle').innerHTML = innerSelectSubtitle.join('');

    })
  });

  document.querySelector('#play').addEventListener('click', () => {
    const url = document.querySelector('#url').value;
    const profile = document.querySelector('#quality').value;
    const video = document.querySelector('#video').value;
    const audio = document.querySelector('#audio').value;
    const subtitle = document.querySelector('#subtitle').value;
    const protocol = document.querySelector('#protocol').value;
    fetch('http://localhost:8585/session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, profile, video, audio, subtitle, protocol })
    }).then(d => d.json()).then(data => {
      console.log(data.session.stream.url)

      var manifestUri = data.session.stream.url;

      function initPlayer() {
        // Create a Player instance.
        var video = document.getElementById('player_video');
        var playerObject = new shaka.Player(video)
        playerObject.configure({
          streaming: {
            retryParameters: {
              timeout: 60000,       // timeout in ms, after which we abort; 0 means never
              maxAttempts: 30000,   // the maximum number of requests before we fail
              baseDelay: 5000,  // the base delay in ms between retries
              backoffFactor: 2, // the multiplicative backoff factor between retries
              fuzzFactor: 0.5,  // the fuzz factor to apply to each retry delay
            }
          }
        });

        console.log('CONF', playerObject.getConfiguration())

        // Attach player to the window to make it easy to access in the JS console.
        window.player = playerObject;

        // Listen for error events.
        playerObject.addEventListener('error', onErrorEvent);

        // Try to load a manifest.
        // This is an asynchronous process.
        playerObject.load(manifestUri).then(function () {
          // This runs if the asynchronous load is successful.
          console.log('The video has now been loaded!');
        }).catch(onError);  // onError is executed if the asynchronous load fails.
      }

      function onErrorEvent(event) {
        // Extract the shaka.util.Error object from the event.
        onError(event.detail);
      }

      function onError(error) {
        // Log the error.
        console.error('Error code', error.code, 'object', error);
      }


      // Install built-in polyfills to patch browser incompatibilities.
      shaka.polyfill.installAll();

      // Check to see if the browser supports the basic APIs Shaka needs.
      if (shaka.Player.isBrowserSupported()) {
        // Everything looks good!
        initPlayer();
      } else {
        // This browser does not have the minimum set of APIs we need.
        console.error('Browser not supported!');
      }

    })
  });








</script>