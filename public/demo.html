<!DOCTYPE html>
<html>

<head>
  <!-- Shaka Player compiled library: -->
  <script src="shaka-player.compiled.js"></script>

  <!-- Required to stream HLS chunks from shaka -->
  <script src="mux.js"></script>

</head>

<body>

  <input value="http://localhost:8585/public/test.mkv" id="url" />
  <button id="load">Load file</button>

  <select id="quality"></select>
  <button id="play">Play!</button>

  <br />
  <video id="video" width="640" controls autoplay></video>
</body>

</html>


<script>
  document.querySelector('#load').addEventListener('click', () => {
    const url = document.querySelector('#url').value;
    fetch('http://localhost:8585/media/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    }).then(d => d.json()).then(data => {
      console.log(data.profiles)
      const innerSelect = data.profiles.map((e, index) => (`<option value="${index}">${e.name}</option>`));
      document.querySelector('#quality').innerHTML = innerSelect.join('');
    })
  });

  document.querySelector('#play').addEventListener('click', () => {
    const url = document.querySelector('#url').value;
    const profile = document.querySelector('#quality').value;
    fetch('http://localhost:8585/session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, profile })
    }).then(d => d.json()).then(data => {
      console.log(data.session.stream.url)

      var manifestUri = data.session.stream.url;

      function initPlayer() {
        // Create a Player instance.
        var video = document.getElementById('video');
        var player = new shaka.Player(video);

        // Attach player to the window to make it easy to access in the JS console.
        window.player = player;

        // Listen for error events.
        player.addEventListener('error', onErrorEvent);

        // Try to load a manifest.
        // This is an asynchronous process.
        player.load(manifestUri).then(function () {
          // This runs if the asynchronous load is successful.
          console.log('The video has now been loaded!');
        }).catch(onError);  // onError is executed if the asynchronous load fails.
      }

      function onErrorEvent(event) {
        // Extract the shaka.util.Error object from the event.
        onError(event.detail);
      }

      function onError(error) {
        // Log the error.
        console.error('Error code', error.code, 'object', error);
      }


      // Install built-in polyfills to patch browser incompatibilities.
      shaka.polyfill.installAll();

      // Check to see if the browser supports the basic APIs Shaka needs.
      if (shaka.Player.isBrowserSupported()) {
        // Everything looks good!
        initPlayer();
      } else {
        // This browser does not have the minimum set of APIs we need.
        console.error('Browser not supported!');
      }

    })
  });








</script>